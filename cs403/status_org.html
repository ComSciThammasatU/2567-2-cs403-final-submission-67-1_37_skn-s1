<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สถานะการรับซื้อขยะ</title> <!-- เปลี่ยน Title -->
    <!-- เพิ่ม CSS ของคุณ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- *** เพิ่ม CSS ที่จำเป็นสำหรับ Navbar (ถ้าหน้านี้มี Navbar) *** -->
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/navigationbar.css">
    <!-- *** สิ้นสุดส่วนที่เพิ่ม *** -->
    <link rel="stylesheet" href="css/style.css"> <!-- ไฟล์ CSS เดิมของคุณ (ถ้ามี) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&display=swap');

body {
    font-family: 'Kanit', 'Sarabun', sans-serif;
    background-color: #f4f6f9;
    color: #333;
    line-height: 1.6;
}

.container.main-content { /* เพิ่มคลาส main-content เพื่อ scope */
    padding-top: 2rem;
    padding-bottom: 2rem;
}

h2.page-title {
    color: #343a40;
    margin-bottom: 2.5rem; /* เพิ่มระยะห่าง */
    font-weight: 600;
    border-bottom: 3px solid #007bff;
    padding-bottom: 0.75rem;
    display: inline-block;
}

/* Card Styling - Refined */
.status-card-org {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.status-card-org:hover {
    transform: translateY(-4px);
    box-shadow: 0 7px 18px rgba(0, 0, 0, 0.12);
}

.card-header-org {
    background-color: #007bff;
    color: white;
    padding: 0.75rem 1.25rem;
    border-bottom: 1px solid #0056b3;
    border-top-left-radius: 0.75rem;
    border-top-right-radius: 0.75rem;
    font-size: 1.15rem;
    font-weight: 500;
    display: flex; /* Added for status badge alignment */
    justify-content: space-between; /* Added for status badge alignment */
    align-items: center; /* Added for status badge alignment */

}
.card-header-org i {
    margin-right: 0.6rem;
}

.card-body-org {
    padding: 1.25rem;
}

.card-body-org p {
    margin-bottom: 0.7rem;
    font-size: 0.95rem;
    color: #495057;
}
.card-body-org p strong {
    color: #212529;
    min-width: 130px; /* Align labels */
    display: inline-block;
    font-weight: 500;
}
.card-body-org p i.fas { /* Target Font Awesome icons specifically */
    color: #007bff;
    margin-right: 0.6rem;
    width: 20px;
    text-align: center;
}

.timestamp-org {
    font-size: 0.85em;
    color: #6c757d;
    margin-top: 1rem;
    padding-top: 0.8rem;
    border-top: 1px solid #f1f1f1;
    text-align: right;
}
.timestamp-org i {
    margin-right: 0.3rem;
}

.card-footer-org {
    padding: 1rem 1.25rem;
    background-color: #f8f9fa;
    border-top: 1px solid #e0e0e0;
    border-bottom-left-radius: 0.75rem;
    border-bottom-right-radius: 0.75rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: flex-end;
}

/* Button Styling - Bigger and more appealing */
.card-footer-org .btn {
    font-size: 0.95rem; /* Adjusted for balance */
    padding: 0.65rem 1.3rem; /* Larger padding */
    border-radius: 0.3rem;
    font-weight: 500;
    /* text-transform: uppercase; */ /* Optional */
    letter-spacing: 0.3px;   /* Optional */
    transition: all 0.2s ease-in-out;
    min-width: 130px; /* Minimum width */
    text-align: center;
    line-height: 1.5; /* Ensure text is centered vertically */
}
.card-footer-org .btn i {
    margin-right: 0.5rem;
}

.card-footer-org .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.card-footer-org .btn-success { background-color: #28a745; border-color: #28a745; color: white; }
.card-footer-org .btn-success:hover { background-color: #218838; border-color: #1e7e34; }

.card-footer-org .btn-danger { background-color: #dc3545; border-color: #dc3545; color: white; }
.card-footer-org .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }

.card-footer-org .btn-info { background-color: #17a2b8; border-color: #17a2b8; color: white; }
.card-footer-org .btn-info:hover { background-color: #138496; border-color: #117a8b; }

.card-footer-org .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: white; }
.card-footer-org .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }

/* Current Status Badge in Header */
.current-status-badge {
    padding: 0.4em 0.9em;  /* เพิ่ม padding ให้ใหญ่ขึ้น */
    font-size: 0.9rem;     /* เพิ่มขนาด font */
    font-weight: 600;      /* อาจจะเพิ่มความหนาตัวอักษร */
    border-radius: 0.3rem; /* ปรับความโค้งมนของขอบ */
    color: white;
    margin-left: 10px;
    /* เพิ่มบรรทัดด้านล่างเพื่อให้ข้อความอยู่กึ่งกลางแนวตั้ง ถ้า padding ไม่เท่ากัน */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 120px; /* กำหนดความกว้างขั้นต่ำ (ถ้าต้องการให้ป้ายมีขนาดเท่าๆ กัน) */
    text-align: center; /* จัดข้อความให้อยู่กึ่งกลาง */
}
.current-status-badge[data-status="รอการตอบกลับ"] { background-color: #6c757d; }
.current-status-badge[data-status="รับ"] { background-color: #0d6efd; }
.current-status-badge[data-status="กำลังไป"] { background-color: #0dcaf0; }
.current-status-badge[data-status="สำเร็จแล้ว"] { background-color: #198754; } /* หรือ 'เสร็จสิ้น' */
.current-status-badge[data-status="เสร็จสิ้น"] { background-color: #198754; } /* เพิ่มเผื่อไว้ */
.current-status-badge[data-status="ไม่รับ"] { background-color: #dc3545; } /* หรือ 'ยกเลิกโดยองค์กร' */
.current-status-badge[data-status="ยกเลิกโดยองค์กร"] { background-color: #dc3545; } /* เพิ่มเผื่อไว้ */
.current-status-badge[data-status="ยกเลิกโดยผู้ใช้"] { background-color: #fd7e14; }




         .loading-indicator, .error-message, .no-data-message { text-align: center; padding: 2rem; color: #6c757d; 
            border: 1px dashed #ced4da;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
            margin-top: 1rem;
        }
        .loading-indicator .spinner-border { width: 3rem; height: 3rem; }
        .error-message i, .no-data-message i { font-size: 2.5rem; margin-bottom: 1rem;
        }
    </style>
</head>
<body>

    <!-- *** ใส่ Navbar ขององค์กรที่นี่ (ถ้าต้องการ) *** -->
    <!-- คัดลอก Navbar จาก index1.html มาวาง -->
    <nav>
        <div class="container">
            <a href="index1.html" class="logo"> <p>TRASH HAS VALUE</p> </a>
            <div class="rightBx">
                <ul class="navBx"></ul>
                <div class="burgerBar burgetBarClick" onclick="controlAllBtnNavigation('navBurger')">
                    <i class='bx bx-menu'></i> <i class='bx bx-x'></i>
                </div>
                <div class="user_Actions" style="display: flex; align-items: center; gap: 10px; margin-left: 15px;">
                    <a href="account.html" id="userAccountLink" class="btn userAccBtn" style="padding: 8px 12px; text-decoration: none; background-color: #007bff; color: white;">กำลังโหลด...</a>
                    <a href="Allbuy.html" class="btn addAddressBtn" style="padding: 8px 12px; background-color: #28a745; color: white; text-decoration: none;">การรับซื้อทั้งหมด</a>
                    <a href="status_org.html" class="btn statusBtn" style="padding: 8px 12px; background-color: #ffc107; color: black; text-decoration: none;">สถานะ</a>
                    <a href="#" class="btn logoutBtn" onclick="logout()" style="padding: 8px 12px; background-color: #dc3545; color: white; text-decoration: none;">ออกจากระบบ</a>
                </div>
                <div class="signup_And_login_BtnBx" style="display: none;">
                    <a href="signup.html" class="btn signUpBtn">ลงทะเบียน</a>
                    <a href="login.html" class="btn loginBtn">ล็อกอิน</a>
                </div>
            </div>
        </div>
    </nav>

    <br>
    <br>
    <br>

    <!-- *** สิ้นสุด Navbar *** -->
    <div class="container main-content mt-4 mb-5"> <!-- เพิ่มคลาส main-content -->
        <h2 class="page-title"><i class="fas fa-inbox me-2"></i>รายการขายขยะที่ส่งถึงคุณ</h2> <!-- เพิ่มคลาส page-title -->
   
        <!-- ส่วนแสดงผลข้อมูล -->
        <div id="status-list">
            <div class="loading-indicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">กำลังโหลดข้อมูล...</p>
            </div>
        </div>

        <!-- ข้อความแสดงเมื่อเกิดข้อผิดพลาด -->
        <div id="error-display" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
            <p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
            <p id="error-details" class="small"></p>
        </div>

         <!-- ข้อความแสดงเมื่อไม่มีข้อมูล -->
         <div id="no-data-display" class="no-data-message" style="display: none;">
            <i class="fas fa-box-open fa-2x text-muted mb-3"></i>
            <p>ยังไม่มีรายการขายขยะส่งถึงคุณ</p>
        </div>

    </div>

    <!-- Footer (ถ้ามี) -->
    <!-- <footer class="footer mt-auto py-3 bg-light"> ... </footer> -->

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- โหลด Navigation Bar JS (ถ้าแยกไฟล์) -->
    <!-- <script src="js/navigationBar.js"></script> -->

    <!-- JavaScript สำหรับโหลดข้อมูลสถานะ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusListDiv = document.getElementById('status-list');
            const loadingIndicator = statusListDiv.querySelector('.loading-indicator');
            const errorDisplayDiv = document.getElementById('error-display');
            const errorDetailsP = document.getElementById('error-details');
            const noDataDisplayDiv = document.getElementById('no-data-display');
            let currentOrgId = null; // เก็บ Organization ID

            // --- ดึง User ID (Organization ID) ปัจจุบัน ---
            const userDataString = sessionStorage.getItem('userData');
            const userAccountLink = document.getElementById('userAccountLink'); // สำหรับแสดงชื่อ Navbar

            if (userDataString) {
                try {
                    const userData = JSON.parse(userDataString);
                    if (userData && userData.length > 0 && userData[0].user_id && userData[0].user_type === 'organization') {
                        currentOrgId = userData[0].user_id;
                        console.log("Organization ID found:", currentOrgId);
                        // แสดงชื่อบน Navbar
                        if (userAccountLink) userAccountLink.textContent = userData[0].firstname || 'องค์กร';
                    } else {
                         console.error("User data is not for an organization or structure is wrong:", userData);
                         showError('ข้อมูลผู้ใช้ไม่ถูกต้อง (ต้องเป็นองค์กร)');
                         if (userAccountLink) userAccountLink.textContent = 'เกิดข้อผิดพลาด';
                         return; // หยุดถ้าไม่ใช่ org
                    }
                } catch (e) {
                    console.error("Error parsing user data:", e);
                    showError('เกิดข้อผิดพลาดในการอ่านข้อมูลผู้ใช้');
                    if (userAccountLink) userAccountLink.textContent = 'เกิดข้อผิดพลาด';
                    return; // หยุดถ้า parse ไม่ได้
                }
            } else {
                console.warn("User data not found in sessionStorage.");
                showError('กรุณาเข้าสู่ระบบในฐานะองค์กรเพื่อดูข้อมูล');
                 if (userAccountLink) userAccountLink.textContent = 'กรุณาล็อกอิน';
                 // อาจจะ redirect ไปหน้า login
                 // window.location.href = 'login.html';
                return; // หยุดการทำงานถ้าไม่พบ user id
            }
            // --- สิ้นสุดการดึง User ID ---

            // ฟังก์ชันสำหรับแสดงข้อผิดพลาด
            function showError(message) {
                loadingIndicator.style.display = 'none';
                statusListDiv.style.display = 'none';
                noDataDisplayDiv.style.display = 'none';
                errorDetailsP.textContent = message;
                errorDisplayDiv.style.display = 'block';
            }

            // ฟังก์ชันสำหรับแสดงเมื่อไม่มีข้อมูล
            function showNoData() {
                loadingIndicator.style.display = 'none';
                statusListDiv.style.display = 'none'; // ซ่อน status list div ด้วย
                errorDisplayDiv.style.display = 'none';
                noDataDisplayDiv.style.display = 'block';
            }

            // ฟังก์ชันสำหรับสร้างการ์ดแสดงสถานะ (ปรับปรุงสำหรับองค์กร)
            function createStatusCard(item) {
                const card = document.createElement('div');
                  card.className = 'status-card-org'; // ใช้คลาสใหม่
                card.dataset.recyclingId = item.id; // เก็บ ID ของรายการ

                // ชื่อผู้ขาย (จากข้อมูลที่ join มา)
                const sellerName = item.user_firstname ? `${item.user_firstname}${item.user_lastname ? ' ' + item.user_lastname : ''}` : 'ไม่ระบุชื่อ';

                // ชื่อผู้รับซื้อ (ถ้ามี)
                const buyerNameDisplay = item.buyer_name ? escapeHtml(item.buyer_name) : '<i>(ยังไม่ระบุผู้รับซื้อ)</i>';
                
                // สถานะปัจจุบันของรายการ
                const currentStatus = item.status || 'รอการตอบกลับ'; // Default if status is null/undefined

                card.innerHTML = `
                   <div class="card-header-org">
                        <span><i class="fas fa-user"></i> ผู้ขาย: ${escapeHtml(sellerName)}</span>
                        <span class="current-status-badge" data-status="${escapeHtml(currentStatus)}">สถานะ: ${escapeHtml(currentStatus)}</span>
                    </div>
                    <div class="card-body-org">
                        <p><strong><i class="fas fa-recycle"></i>ประเภท:</strong> ${escapeHtml(item.waste_type || 'N/A')}</p>
                        <p><strong><i class="fas fa-weight-hanging"></i>น้ำหนัก:</strong> ${escapeHtml(item.weight || 'N/A')} กก.</p>
                        <p><strong><i class="fas fa-map-marker-alt"></i>ที่อยู่ผู้ขาย:</strong> ${escapeHtml(item.address || 'N/A')}</p>
                        <p><strong><i class="fas fa-store"></i>ผู้รับซื้อที่เลือก:</strong> ${buyerNameDisplay}</p>
                        <p class="timestamp-org"><i class="far fa-clock"></i>ส่งคำขอเมื่อ: ${escapeHtml(item.timestamp_formatted || item.timestamp || 'N/A')}</p>
                    </div>
                    <div class="card-footer-org">
                        <!-- ปุ่ม Action ต่างๆ -->
                        <button class="btn btn-success action-btn" data-id="${item.id}" data-status="รับ">
                            <i class="fas fa-check me-1"></i> รับ
                        </button>
                        <button class="btn btn-danger action-btn" data-id="${item.id}" data-status="ไม่รับ">
                            <i class="fas fa-times me-1"></i> ไม่รับ
                        </button>
                        <button class="btn btn-info action-btn" data-id="${item.id}" data-status="กำลังไป"> <!-- Removed text-dark -->
                            <i class="fas fa-truck-fast me-1"></i> กำลังไป
                        </button>
                        <button class="btn btn-secondary action-btn" data-id="${item.id}" data-status="สำเร็จแล้ว">
                            <i class="fas fa-check-double me-1"></i> สำเร็จแล้ว
                        </button>
                    </div>
                `;
                return card;
            }

            // ฟังก์ชัน escape HTML
            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return unsafe;
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }

            // --- ฟังก์ชันโหลดข้อมูล ---
            function loadRecyclingRequests() {
                loadingIndicator.style.display = 'block';
                statusListDiv.style.display = 'block'; // แสดง div หลักไว้ก่อน
                errorDisplayDiv.style.display = 'none';
                noDataDisplayDiv.style.display = 'none';
                statusListDiv.innerHTML = ''; // ล้างข้อมูลเก่า (ยกเว้น loading indicator ที่จะใส่ใหม่)
                statusListDiv.appendChild(loadingIndicator); // ใส่ loading indicator กลับเข้าไป

                fetch('./get_org_recyclings.php') // *** เปลี่ยน URL เป็นขององค์กร ***
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`Server error (${response.status}): ${text || 'Unknown server error'}`);
                            });
                        }
                        return response.json();
                    })
                    .then(result => {
                        loadingIndicator.style.display = 'none'; // ซ่อน loading ก่อนแสดงผล

                        if (result.status === 'success') {
                            if (result.data && result.data.length > 0) {
                                const processedFingerprints = new Set(); // เก็บ "ลายนิ้วมือ" ของรายการที่แสดงผลแล้ว
                                statusListDiv.innerHTML = ''; // ล้าง loading indicator จริงๆ
                                result.data.forEach(item => {
                                     // สร้าง fingerprint จากข้อมูลสำคัญ
                                    const sellerName = item.user_firstname ? `${item.user_firstname}${item.user_lastname ? ' ' + item.user_lastname : ''}` : 'ไม่ระบุชื่อ';
                                    const currentStatus = item.status || 'รอการตอบกลับ';
                                    const wasteType = item.waste_type || 'N/A';
                                    const weight = String(item.weight || 'N/A');
                                    const address = item.address || 'N/A';
                                    const buyerName = item.buyer_name || 'N/A'; // ชื่อองค์กรปัจจุบัน
                                    const timestamp = item.timestamp_formatted || item.timestamp || 'N/A';

                                    const fingerprint = `${sellerName}|${currentStatus}|${wasteType}|${weight}|${address}|${buyerName}|${timestamp}`;

                                    if (processedFingerprints.has(fingerprint)) {
                                        return; // ข้ามรายการนี้ถ้าซ้ำ
                                    }
                                    processedFingerprints.add(fingerprint);
                                    const card = createStatusCard(item);
                                    statusListDiv.appendChild(card);
                                });
                            } else {
                                showNoData(); // แสดงว่าไม่มีข้อมูล
                            }
                        } else {
                            showError(result.message || 'ไม่สามารถดึงข้อมูลได้');
                        }
                    })
                    .catch(error => {
                        console.error('Fetch Error:', error);
                        showError(error.message || 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
                    });
            }

            // --- ฟังก์ชันอัปเดตสถานะ ---
            function updateStatus(recyclingId, newStatus, cardElement) {
                let confirmTitle = 'ยืนยันการดำเนินการ';
                let confirmText = `ต้องการเปลี่ยนสถานะเป็น "${newStatus}" หรือไม่?`;
                let confirmIcon = 'question';
                let confirmButtonColor = '#3085d6'; // Default blue

                if (newStatus === 'ไม่รับ') {
                    confirmTitle = 'ยืนยันการปฏิเสธ';
                    confirmText = "รายการนี้จะถูกแจ้งให้ผู้ใช้ทราบว่าถูกปฏิเสธ และจะหายไปจากหน้านี้";
                    confirmIcon = 'warning';
                    confirmButtonColor = '#d33'; // Red
                } else if (newStatus === 'สำเร็จแล้ว') {
                    confirmTitle = 'ยืนยันการเสร็จสิ้น';
                    confirmText = "รายการนี้จะถูกแจ้งให้ผู้ใช้ทราบว่าเสร็จสิ้น และจะหายไปจากหน้านี้";
                    confirmIcon = 'success';
                    confirmButtonColor = '#198754'; // Green
                } else if (newStatus === 'รับ') {
                     confirmText = "ผู้ใช้จะเห็นสถานะเป็น 'รับ' ในหน้าของตนเอง";
                     confirmIcon = 'info';
                } else if (newStatus === 'กำลังไป') {
                     confirmText = "ผู้ใช้จะเห็นสถานะเป็น 'กำลังไป' ในหน้าของตนเอง";
                     confirmIcon = 'info';
                }


                Swal.fire({
                    title: confirmTitle,
                    text: confirmText,
                    icon: confirmIcon,
                    showCancelButton: true,
                    confirmButtonColor: confirmButtonColor,
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'ยืนยัน',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'กำลังอัปเดต...',
                            allowOutsideClick: false,
                            didOpen: () => { Swal.showLoading(); }
                        });

                        fetch('./update_recycling_status.php', { // *** URL สำหรับอัปเดต ***
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            // ส่ง id และ status ใหม่ไป
                            body: `id=${recyclingId}&status=${newStatus}`
                        })

                        
                        .then(response => response.ok ? response.json() : response.text().then(text => Promise.reject(text)))
                        .then(data => {
                            Swal.close();
                            if (data.status === 'success') {
                                Swal.fire('สำเร็จ!', 'อัปเดตสถานะเรียบร้อยแล้ว', 'success');

                                  // ถ้าสถานะใหม่เป็น 'ไม่รับ' หรือ 'สำเร็จแล้ว' ให้ลบ card ออก
                                  if (newStatus === 'ไม่รับ') {
                                    cardElement.remove();
                                    // ตรวจสอบว่ามีรายการเหลือหรือไม่
                                    if (statusListDiv.querySelectorAll('.status-card-org').length === 0) {
                                        showNoData();
                                    }
                                } else {
                                     // อัปเดต UI ของการ์ดนี้โดยตรงสำหรับสถานะ 'รับ' หรือ 'กำลังไป'
                                     const statusBadge = cardElement.querySelector('.current-status-badge');
                                    if (statusBadge) {
                                        statusBadge.textContent = `สถานะ: ${escapeHtml(newStatus)}`;
                                        statusBadge.dataset.status = newStatus; // อัปเดต data-status สำหรับ CSS
                                    }

                                    // อัปเดตสถานะของปุ่มบนการ์ดนี้
                                    const acceptBtn = cardElement.querySelector('.action-btn[data-status="รับ"]');
                                    const rejectBtn = cardElement.querySelector('.action-btn[data-status="ไม่รับ"]');
                                    const onWayBtn = cardElement.querySelector('.action-btn[data-status="กำลังไป"]');
                                    const completedBtn = cardElement.querySelector('.action-btn[data-status="สำเร็จแล้ว"]');

                                    if (newStatus === 'รับ') {
                                        if (acceptBtn) acceptBtn.disabled = true;
                                        if (rejectBtn) rejectBtn.disabled = true; // ไม่สามารถปฏิเสธหลังรับแล้ว
                                        if (onWayBtn) onWayBtn.disabled = false;
                                        if (completedBtn) completedBtn.disabled = false; // หรือ true หากต้อง "กำลังไป" ก่อน
                                    } else if (newStatus === 'กำลังไป') {
                                        if (acceptBtn) acceptBtn.disabled = true;
                                        if (rejectBtn) rejectBtn.disabled = true;
                                        if (onWayBtn) onWayBtn.disabled = true;
                                        if (completedBtn) completedBtn.disabled = false;
                                    }
                                }
                            } else {
                                throw new Error(data.message || 'ไม่สามารถอัปเดตสถานะได้');
                            }
                        })
                        .catch(error => {
                            Swal.close();
                            console.error('Error updating status:', error);
                            Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถอัปเดตสถานะได้ (${error.message})`, 'error');
                        });
                    }
                });
            }

            // --- Event Listener สำหรับปุ่ม Action (ใช้ Event Delegation) ---
            statusListDiv.addEventListener('click', function(event) {
                const actionButton = event.target.closest('.action-btn');
                if (actionButton && !actionButton.disabled) { // ตรวจสอบว่าปุ่มไม่ถูก disable
                    const recyclingId = actionButton.dataset.id;
                    const newStatus = actionButton.dataset.status;
                    const cardElement = actionButton.closest('.status-card-org'); // หา card แม่ (ใช้คลาสใหม่)

                    if (!currentOrgId) { // ตรวจสอบ Org ID อีกครั้ง
                        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถระบุองค์กรปัจจุบันได้ โปรดลองเข้าสู่ระบบใหม่', 'error');
                        return;
                    }

                    updateStatus(recyclingId, newStatus, cardElement);
                }
            });

            // --- เริ่มโหลดข้อมูลครั้งแรก ---
            if (currentOrgId) { // ตรวจสอบว่ามี ID ก่อนโหลด
                 loadRecyclingRequests();
            }

        });

        // --- ฟังก์ชัน Logout (ถ้า Navbar ไม่มี) ---
        function logout() {
            sessionStorage.removeItem('userData');
            window.location.href = 'login.html';
        }

        // --- ฟังก์ชัน controlAllBtnNavigation (ถ้า Navbar ไม่มี) ---
        function controlAllBtnNavigation(type) {
            console.log("Control button clicked:", type);
            const navBx = document.querySelector('.navBx');
            const burgerBar = document.querySelector('.burgerBar');
            if (type === 'navBurger' && navBx && burgerBar) {
                navBx.classList.toggle('active');
                burgerBar.classList.toggle('active');
            }
        }
    </script>

</body>
</html>
